<!--
    Kayo Unofficial Dekstop App
    Copyright (C) 2019 etopiei
    The GNU GPLv2 License applies to this project.
    You should receieve a copy of the license with this software.
-->

<html>
    <head>
        <link href="./main.css" media="screen" rel="stylesheet" type="text/css">
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    </head>
    <body>
        <h3>Kayo</h3>
        <div id="Login">
            <input type="text" name="username" id="username" placeholder="Email">
            <input type="password" name="password" id="password" placeholder="Password">
            <button onclick="goLogin()">Login</button>
        </div>
        <div id="Profile">
            <p>Loading Profiles. Please Wait.</p>
        </div>
        <div id="Channels">
            <p>Loading Live Events. Please Wait.</p>
        </div>
        <div id="Stream">
            <video id="stream-el"></video>
        </div>
    </body>
</html>
<script>

/*************************************************
 * GLOBAL STATE OF APP HERE
 ************************************************/
// Load access token from file if it exists.
// Otherwise show the login screen to get details.
// Also check for the refresh token and give that a crack maybe?
var accessTokenObject = null;
var views = ["Login", "Profile", "Channels", "Stream"];
var current_view = 0;
var profile = null;
var stream_id = null;

/**************************************************
 * UI FUNCTIONS BELOW HERE 
 * These are the only functions that should interact with Kayo functions, and also the only functions that alter the global app state.
 *************************************************/ 

function changeView(newView) {
    let index = views.indexOf(newView);
    current_view = index;
    // Hide all views except the new one
    views.filter(v => v !== newView).forEach(view => {
        document.getElementById(view).style.display = 'none';
    });
    // Show the new view
    if (newView === "Channels") {
        document.getElementById(newView).style.display = "flex";
    } else {
        document.getElementById(newView).style.display = "block";
    }
}

// Pass the input text fields to the login function
function goLogin() {
    changeView("Login");
    login(document.getElementById("username").value, document.getElementById("password").value).then(data => {
        accessTokenObject = data;
        goProfile();
    }).catch(err => {
        console.log("Failed to login! :O", err);
    });
}


// This will construct an HTML element for the profile and listen for clicks.
function constructProfile(name, id) {
    const div = document.createElement('div');
    div.innerText = name;
    div.className = "choice"
    div.addEventListener('click', () => {
        // here select profile and move to the channels screen.
        profile = id;
        goChannels();
    });
    return div;
}

// Get the list of profiles and display them.
function goProfile() {
    changeView("Profile");
    getProfiles(accessTokenObject["access_token"]).then(data => {
        console.log(data);
        document.getElementById("Profile").innerHTML = "";
        // Here convert profile data to some sembalance of a UI
        data.forEach(profile => {
            let name = profile.name;
            let id = profile.id;
            let profileBlock = constructProfile(name, id);
            document.getElementById("Profile").appendChild(profileBlock);
        });
    }).catch(err => {
        console.log(err);
        // Probably need to re-prompt for login here
    });
}

function constructEvent(id, title, desc, sport) {
    const ev = document.createElement("div");
    ev.innerText = `${title} - ${sport}`;
    ev.className = "event";
    ev.addEventListener('click', () => {
        stream_id = id;
        goStream();
    });
    return ev;
}

function goChannels() {
    changeView("Channels");
    getEvents(accessTokenObject["access_token"], profile).then(data => {
        console.log(data);
        document.getElementById("Channels").innerHTML = "";
        const channel_heading = document.createElement("h2");
        channel_heading.innerText = "Live Events";
        document.getElementById("Channels").appendChild(channel_heading);
        const live_events = data[1].contents;
        live_events.forEach(event => {
            let id = event.data.asset.id;
            let title = event.data.asset.title;
            let description = event.data.asset.description;
            let sport = event.data.asset.sport;
            let eventBlock = constructEvent(id, title, description, sport);
            document.getElementById("Channels").appendChild(eventBlock);
        });
    }).catch(err => {
        console.log(err);
    });
}

function goStream() {
    changeView("Stream");
    getStream(accessTokenObject["access_token"], profile, stream_id).then(response => {
        const video = document.getElementById('stream-el');
        const source = response.data[0].recommendedStream.manifest.uri;

        if(Hls.isSupported()) {
            var hls = new Hls();
            hls.loadSource(source);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED,function() {
                video.play();
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = source;
            video.addEventListener('loadedmetadata', function() {
                video.play();
            });
        }
    }).catch(err => {
        console.log(err);
    });
}

/**************************************************
 * KAYO FUNCTIONS BELOW HERE - May Seperate this into library later
 * The Kayo functions are all API calls that return Promises that resolve to data or reject with an error.
 * They should not touch app state at all, this way the library can be re-used.
 **************************************************/

// First things first, let's get a Kayo access token
function login(USERNAME, PASSWORD) {
    return new Promise((resolve, reject) => {
        fetch('https://auth.kayosports.com.au/oauth/token', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                audience: "kayosports.com.au",
                grant_type: "http://auth0.com/oauth/grant-type/password-realm",
                scope: "openid offline_access",
                realm: "prod-martian-database",
                client_id: "qjmv9ZvaMDS9jGvHOxVfImLgQ3G5NrT2",
                username: USERNAME,
                password: PASSWORD
            })
        }).then(res => res.json()).then(data => {
            resolve(data);
        }).catch(err => {
            reject(err);
        });
    });
}

// Use the access token to get a list of profiles to use to login.
function getProfiles(accessToken) {
    return new Promise((resolve, reject) => {
        fetch("https://profileapi.kayosports.com.au/user/profile", {
        headers: {
            "Authorization": `Bearer ${accessToken}`
        }
        }).then(res => res.json()).then(data => {
            resolve(data);
        }).catch(err => {
            reject(err);
        });
    });
}

function getEvents(accessToken, profileId) {
    return new Promise((resolve, reject) => {
        fetch(`https://vccapi.kayosports.com.au/v2/content/types/landing/names/sports?evaluate=3&profile=${profileId}`, {
            headers: {
                "Authorization": `Bearer ${accessToken}`
            }
        }).then(res => res.json()).then(data => {
            resolve(data);
        }).catch(err => {
            reject(err);
        });
    });
}

function getStream(accessToken, profileId, streamId) {
    return new Promise((resolve, reject) => {
        fetch(`https://vmndplay.kayosports.com.au/api/v1/asset/${streamId}/play.json?fields=alternativeStreams`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({})
        }).then(res => res.json()).then(data => {
            resolve(data);
        }).catch(err => {
            reject(err);
        })
    });
}
</script>
